create database db_sia

use db_sia

create table tb_fakultas(
fklts_1 int auto_increment primary key,
fklts_2 varchar(50),
fklts_3 datetime
)

create table tb_prodi(
prodi_1 int auto_increment primary key,
fklts_1 int,
prodi_2 varchar(50),
prodi_3 datetime,
foreign key (fklts_1) references tb_fakultas(fklts_1) on delete cascade on update cascade
)

create table tb_mhs(
mhs_1 int auto_increment primary key,
mhs_2 varchar(30),
mhs_3 varchar(100),
prodi_1 int,
mhs_4 varchar(30),
mhs_5 date,
mhs_6 varchar(200),
mhs_7 varchar(100),
mhs_8 datetime,
foreign key (prodi_1) references tb_prodi(prodi_1) on delete cascade on update cascade
)

create table tb_dosen(
dsn_1 int auto_increment primary key,
dsn_2 varchar(30),
dsn_3 varchar(100),
dsn_4 varchar(30),
dsn_5 date, 
dsn_6 varchar(200),
dsn_7 varchar(100),
dsn_8 datetime
)

create table tb_makul(
mkl_1 int auto_increment primary key,
prodi_1 int,
mkl_2 varchar(100),
mkl_3 int,
mkl_4 varchar(10),
mkl_5 datetime,
foreign key (prodi_1) references tb_prodi(prodi_1) on delete cascade on update cascade
)

create table tb_kelas(
kls_1 int auto_increment primary key,
kls_2 varchar(20),
mkl_1 int,
kls_3 int,
kls_4 int, 
kls_5 datetime,
foreign key (mkl_1) references tb_makul(mkl_1) on delete cascade on update  cascade
)

create table tb_pengampu(
ampu_1 int auto_increment primary key,
dsn_1 int,
kls_1 int,
ampu_2 datetime,
foreign key (dsn_1) references tb_dosen(dsn_1) on delete cascade on update cascade,
foreign key (kls_1) references tb_kelas(kls_1) on delete cascade on update cascade
)

create table tb_ambil_kls(
abl_kls_1 int auto_increment primary key,
mhs_1 int,
kls_1 int,
abl_kls_2 varchar(10),
abl_kls_3 varchar(10),
abl_kls_4 datetime,
foreign key (mhs_1) references tb_mhs(mhs_1) on delete cascade on update cascade,
foreign key (kls_1) references tb_kelas(kls_1) on delete cascade on update cascade
)

create table tb_nilai(
nil_1 int auto_increment primary key,
abl_kls_1 int,
nil_2 int,
nil_3 int,
nil_4 int,
nil_5 int,
nil_6 varchar(10),
nil_7 varchar(5),
nil_8 int,
foreign key (abl_kls_1) references tb_ambil_kls(abl_kls_1) on delete cascade on update cascade
)

create table tb_setting(
set_1 int auto_increment primary key,
set_2 varchar(100),
set_3 varchar(10),
set_4 varchar(10),
set_5 int,
set_6 datetime
)


CREATE VIEW form_prodi
AS
SELECT tb_prodi.prodi_1, tb_prodi.prodi_2, tb_prodi.fklts_1, tb_fakultas.fklts_2, tb_prodi.prodi_3 
FROM tb_prodi inner join tb_fakultas ON tb_prodi.fklts_1=tb_fakultas.fklts_1


SELECT * FROM form_prodi

DROP VIEW form_mhs

CREATE VIEW form_mhs
AS
SELECT tb_mhs.mhs_1, tb_mhs.mhs_2, tb_mhs.mhs_3, tb_fakultas.fklts_2, tb_mhs.prodi_1, tb_prodi.prodi_2, tb_mhs.mhs_4, tb_mhs.mhs_5, tb_mhs.mhs_6, tb_mhs.mhs_8
FROM tb_mhs inner join tb_prodi ON tb_mhs.prodi_1=tb_prodi.prodi_1
INNER JOIN tb_fakultas ON tb_prodi.fklts_1=tb_fakultas.fklts_1 
group by tb_mhs.mhs_1 desc

SELECT * FROM form_mhs group by mhs_1 desc

CREATE VIEW fklts_prodi
AS
SELECT tb_prodi.prodi_1, tb_fakultas.fklts_2, tb_prodi.prodi_2
FROM tb_prodi INNER JOIN tb_fakultas ON tb_prodi.fklts_1=tb_fakultas.fklts_1

SELECT * FROM fklts_prodi

CREATE VIEW form_makul
AS
SELECT tb_makul.mkl_1, tb_makul.mkl_2, tb_fakultas.fklts_1, tb_fakultas.fklts_2, tb_makul.prodi_1, tb_prodi.prodi_2, tb_makul.mkl_3, tb_makul.mkl_4, tb_makul.mkl_5
FROM tb_makul INNER JOIN tb_prodi ON tb_makul.prodi_1=tb_prodi.prodi_1 
INNER JOIN tb_fakultas ON tb_prodi.fklts_1=tb_fakultas.fklts_1

SELECT * FROM form_makul

CREATE VIEW form_kelas
AS
SELECT tb_kelas.kls_1, tb_kelas.kls_2, tb_kelas.mkl_1, tb_makul.mkl_2, tb_prodi.prodi_2, tb_kelas.kls_3, tb_kelas.kls_4
FROM tb_kelas INNER JOIN tb_makul ON tb_kelas.mkl_1=tb_makul.mkl_1
INNER JOIN tb_prodi ON tb_makul.prodi_1=tb_prodi.prodi_1

SELECT * FROM form_kelas

drop view form_kelas

CREATE VIEW prodi_makul
AS
SELECT tb_makul.mkl_1, tb_prodi.prodi_2, tb_makul.mkl_2
FROM tb_makul INNER JOIN tb_prodi ON tb_makul.prodi_1=tb_prodi.prodi_1

SELECT * FROM prodi_makul

CREATE TABLE tb_user(
usr_1 int auto_increment primary key,
usr_2 varchar(30) UNIQUE,
usr_3 varchar(100),
usr_4 int,
usr_5 int,
usr_6 int,
usr_7 datetime
)

drop table tb_user

#trigger untuk membuat akun mhs pd tb_user setelah insert pd tb_mhs
DELIMITER |
CREATE TRIGGER create_user_mhs
AFTER INSERT ON tb_mhs
FOR EACH ROW 
BEGIN
	INSERT INTO tb_user (usr_2, usr_3, usr_4, usr_5, usr_6, usr_7)
	VALUES (new.mhs_2, new.mhs_2, 2, 1, new.mhs_1, new.mhs_8);
END;|

#prosedure untuk menghapus akun dr mahasiswa pd tb_user
DELIMITER |
CREATE PROCEDURE delete_mhs_usr (IN id_mhs INT)
BEGIN
DECLARE id_user int;
SELECT tb_user.usr_1 INTO id_user FROM tb_user WHERE usr_6=id_mhs AND usr_4=2;
DELETE FROM tb_user WHERE usr_1=id_user;
END;|

call delete_mhs_usr(21)

drop procedure delete_mhs_dosen

#trigger untuk membuat akun dosen pd tb_user setelah insert pd tb_dosen
DELIMITER |
CREATE TRIGGER create_user_dosen
AFTER INSERT ON tb_dosen
FOR EACH ROW
BEGIN
	INSERT INTO tb_user (usr_2, usr_3, usr_4, usr_5, usr_6, usr_7)
	VALUES (new.dsn_2, new.dsn_2, 3, 1, new.dsn_1, new.dsn_8);
END;|

#prosedure untuk menghapus akun dr dosen pd tb_user
DELIMITER |
CREATE PROCEDURE delete_dsn_usr (IN id_dosen INT)
BEGIN
DECLARE id_user int;
SELECT tb_user.usr_1 INTO id_user FROM tb_user WHERE usr_6=id_dosen AND usr_4=3;
DELETE FROM tb_user WHERE usr_1=id_user;
END;|

call delete_dsn_usr(4)





